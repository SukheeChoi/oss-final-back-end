<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ows.edu.dao.ReleaseInspectionDao">

 	<resultMap id="afterPickingMap" type="releaseInspection">
		<result property="releaseInspectionQuantity" column="RI_QTY"/>
		<result property="unReleased" column="RI_URLS"/>
		<result property="employeeName" column="RI_EMP_NAME"/>			
		<result property="releasePrintDate" column="RI_RLS_PRT_DT"/>
		<result property="receiptePrintDate" column="RI_RCPT_PRT_DT"/>
		<result property="releaseInspectionDate" column="RI_DT"/>
		<result property="releaseInspectionNote" column="RI_NT"/>
		
		<association property="release" javaType="release">
			<result property="releaseNo" column="RLS_NO"/>
			<result property="invoiceCode" column="RLS_RLS_IVC_CODE"/>
			<result property="employeeName" column="RLS_EMP_NAME"/>			
			<result property="shippingCompany" column="RLS_SHP_CPN"/>			
			<result property="note" column="RLS_RLS_NT"/>
		</association>
		<association property="item" javaType="item">
			<result property="itemName" column="ITM_NAME"/>
			<result property="itemCode" column="ITM_CODE"/>
		</association>
		<association property="picking" javaType="picking">
			<result property="pickingNo" column="PIC_NO"/>
		</association>
		<association property="vendor" javaType="vendor">
			<result property="vendorName" column="V_NAME"/>
		</association>
		<association property="order" javaType="order">
			<result property="shippingDestination" column="ORD_SHP_DEST"/>			
			<result property="shippingCategory" column="ORD_SHP_CAT"/>			
			<result property="shippingWay" column="ORD_SHP_WAY"/>			
			<result property="orderNo" column="ORD_NO"/>			
		</association>
		<association property="packing" javaType="packing">
			<result property="unrelease" column="PAC_URLS"/>			
			<result property="boxQty" column="PAC_BX_QTY"/>			
			<result property="note" column="PAC_NT"/>		
		</association>
	</resultMap>
	
	<select id="countReleaseInspection" resultType="int">
		SELECT COUNT(*)
		FROM TB_RLS_INSP RI
		JOIN TB_ORD_ITM OI
			ON (RI.OI_NO=OI.OI_NO)
		LEFT JOIN TB_ORD O
			ON (O.ORD_NO=OI.ORD_NO)    
		WHERE O.ORD_PRC_ORD IS NULL
	</select>
	<select id="sumUnreleased" resultType="int">
		SELECT SUM(RI.RI_URLS)
		FROM TB_RLS_INSP RI
		JOIN TB_ORD_ITM OI
			ON (RI.OI_NO=OI.OI_NO)
		LEFT JOIN TB_ORD O
			ON (O.ORD_NO=OI.ORD_NO)
		WHERE O.ORD_PRC_ORD IS NULL
	</select>
	<select id="countExpressShipping" resultType="int">
		SELECT COUNT(*)
		FROM TB_RLS_INSP RI
		JOIN TB_ORD_ITM OI
			ON (RI.OI_NO=OI.OI_NO)
		LEFT JOIN TB_ORD O
			ON (O.ORD_NO=OI.ORD_NO)
		WHERE O.ORD_PRC_ORD IS NULL 
			AND O.ORD_SHP_CAT='긴급'
	</select>
	<select id="countNormalShipping" resultType="int">
		SELECT COUNT(*)
		FROM TB_RLS_INSP RI
		JOIN TB_ORD_ITM OI
			ON (RI.OI_NO=OI.OI_NO)
		LEFT JOIN TB_ORD O
			ON (O.ORD_NO=OI.ORD_NO)
		WHERE O.ORD_PRC_ORD IS NULL 
			AND O.ORD_SHP_CAT='일반'
	</select>

 	<select id="selectAfterPickingList" resultMap="afterPickingMap">
		SELECT R.RLS_NO, I.ITM_NAME, I.ITM_CODE, PI.PIC_NO
			, RI.RI_QTY, RI_URLS, PA.PAC_URLS, V.V_NAME, O.ORD_SHP_DEST
		    , O.ORD_SHP_CAT, O.ORD_SHP_WAY, E.EMP_NAME RI_EMP_NAME
		    , RI.RI_RLS_PRT_DT, RI.RI_RCPT_PRT_DT, RI.RI_DT, PA.PAC_BX_QTY
		    , R.RLS_EMP_NAME, R.RLS_SHP_CPN, R.RLS_RLS_IVC_CODE, IFNULL(RI.RI_NT, ' ') RI_NT
		    , IFNULL(PA.PAC_NT, ' ') PAC_NT, IFNULL(R.RLS_RLS_NT, ' ') RLS_RLS_NT
		    , R.RLS_DN, O.ORD_NO, C.CLT_NAME
		FROM TB_ORD O
		JOIN (SELECT RLS.RLS_NO RLS_NO, RLS.ORD_NO RLS_ORD_NO, EMP.EMP_NAME RLS_EMP_NAME
					, RLS_SHP_CPN, RLS.RLS_IVC_CODE RLS_RLS_IVC_CODE, RLS.RLS_NT RLS_RLS_NT
		            , RLS_DN
			  FROM TB_RLS RLS
		      JOIN TB_EMP EMP
				ON (RLS.EMP_ID=EMP.EMP_ID)
			) R
			ON (O.ORD_NO=R.RLS_ORD_NO)
		RIGHT JOIN TB_ORD_ITM OI
				ON (O.ORD_NO=OI.ORD_NO)
		JOIN TB_ITM I
			ON (OI.ITM_CODE=I.ITM_CODE)
		JOIN TB_VND V
			ON (I.V_NO=V.V_NO)
		JOIN TB_RLS_INSP RI
			ON (OI.OI_NO=RI.OI_NO)
		JOIN TB_PIC PI
			ON (OI.OI_NO=PI.OI_NO)
		JOIN TB_PAC PA
			ON (OI.OI_NO=PA.OI_NO)
		JOIN TB_EMP E
			ON (RI.EMP_ID=E.EMP_ID)
		JOIN TB_CLT C
			ON (C.CLT_NO=O.CLT_NO)
<where>
	<!-- 배송구분 필터링: 전체/일반/긴급 -->
<!--    	<if test='(shippingCategory != null) and (shippingCategory.equals("일반"))'>
		AND O.ORD_SHP_CAT='일반'
	</if>
	<if test='(shippingCategory != null) and (shippingCategory.equals("긴급"))'>
		AND O.ORD_SHP_CAT='긴급'
	</if> -->
	<!-- 배송방식 필터링: 전체/오스템/합배송 -->
 <!--   	<if test='(shippingWay != null) and (shippingWay.equals("오스템"))'>
		AND O.ORD_SHP_WAY='오스템'
	</if>
	<if test='(shippingWay != null) and (shippingWay.equals("합배송"))'>
		AND O.ORD_SHP_WAY='합배송'
	</if> -->
	<!-- 출고/미출고 필터링 -->
<!--    	<if test='(released != null) and (released.equals("출고"))'>
		AND R.RLS_DN=1
	</if>
	<if test='(released != null) and (released.equals("미출고"))'>
		AND R.RLS_DN IS NULL
	</if> -->
	
	<!-- assignee 필수여야 작동하는 이유는..? -->
	<!-- 출고검수/패킹 담당자 필터링 -->
<!--     <if test='assignee != null'>
		AND CONCAT(E.EMP_NAME, '') LIKE CONCAT('%',#{assignee},'%')
	</if> -->
	
	<!-- 주문번호 필터링 -->
	<!-- <if test='orderNo != -1'> -->
	<!-- <if test='!strOrderNo.equals("-1")'> -->
 		<!-- AND CONCAT(O.ORD_NO, '') LIKE CONCAT('%',#{orderNo},'%') -->
<!--    		AND CONCAT(O.ORD_NO, '') LIKE CONCAT('%',#{strOrderNo},'%')
	</if> -->
	
	<!-- 거래처 필터링 -->
<!--    	<if test='clientName != null'>
		AND C.CLT_NAME LIKE CONCAT('%',#{clientName},'%')
	</if> -->
	
	<!-- 배송지 필터링 -->
 <!--   	<if test='shippingDestination != null'>
 		AND O.ORD_SHP_DEST LIKE CONCAT('%',#{shippingDestination},'%')
 	</if> -->
 	<!-- 업체명으로 필터링 -->
<!--    	<if test='vendorName != null'>
   		AND V.V_NAME LIKE CONCAT('%',#{vendorName},'%')
   	</if> -->
	
</where>
		ORDER BY R.RLS_NO, I.ITM_NAME
 	</select>
 	

<!-- ========================================현주======================================== -->
<!-- UPDATE 테이블이름
SET 필드이름1=데이터값1, 필드이름2=데이터값2, ...
WHERE 필드이름=데이터값 -->

	<!-- 검수수량, 미출고수량 업데이트 -->
	<update id="releaseInspectionQtyUpdate" parameterType="Map">
		UPDATE TB_RLS_INSP
		INNER JOIN tb_ord_itm on tb_rls_insp.oi_no = tb_ord_itm.oi_no
		INNER JOIN tb_ord on TB_ORD_ITM.ord_no = TB_ORD.ord_no
		INNER JOIN tb_rls on TB_ORD.ord_no = tb_rls.ord_no
		set tb_rls_insp.ri_qty = if(tb_rls_insp.ri_qty is null, 1, TB_RLS_INSP.ri_qty+1)
		WHERE TB_RLS.RLS_CODE = #{releaseCode}
			and TB_RLS_INSP.ri_brcd = #{scannedBarcode};
	</update>
	
	<update id="unRleaseQtyUpdate" parameterType="Map">
		UPDATE TB_RLS_INSP
		INNER JOIN tb_ord_itm on tb_rls_insp.oi_no = tb_ord_itm.oi_no
		INNER JOIN tb_ord on TB_ORD_ITM.ord_no = TB_ORD.ord_no
		INNER JOIN tb_rls on TB_ORD.ord_no = tb_rls.ord_no
		set tb_rls_insp.RI_URLS = if(tb_rls_insp.RI_URLS is null, 1, TB_RLS_INSP.RI_URLS+1)
		WHERE TB_RLS.RLS_CODE = #{releaseCode}
		and TB_RLS_INSP.ri_brcd = #{scannedBarcode}
	</update>
	
	<resultMap id="releaseInspectionScanMap" type="releaseInspection">
		<result property="releaseInspectionQuantity" column="RI_QTY"/>
		<result property="unReleased" column="RI_URLS"/>		
		<result property="releasePrintDate" column="RI_RLS_PRT_DT"/>
		<result property="receiptePrintDate" column="RI_RCPT_PRT_DT"/>
		<result property="releaseInspectionDate" column="RI_DT"/>
		<result property="releaseInspectionNote" column="RI_NT"/>	
		<association property="release" javaType="release">
			<result property="releaseCode" column="RLS_CODE"/>		
		</association>
		<association property="order" javaType="order">		
			<result property="shippingCategory" column="ORD_SHP_CAT"/>					
			<result property="orderNo" column="ORD_NO"/>		
			<result property="clientNo" column="clt_no"/>	
		</association>
		<association property="picking" javaType="picking">
			<result property="pickingQty" column="PIC_QTY"/>
		</association>
		<association property="client" javaType="client">
			<result property="clientName" column="CLT_NAME"/>
		</association>
	</resultMap>
		
	<!-- scan버튼 눌렀을때 정보 띄우기 -->
	<select id="scan" parameterType="String" resultMap="releaseInspectionScanMap">
		select sum(TB_RLS_INSP.RI_QTY) as "RI_QTY", TB_RLS_INSP.RI_DT, TB_RLS_INSP.RI_RLS_PRT_DT, TB_RLS_INSP.RI_RCPT_PRT_DT,
			TB_RLS_INSP.EMP_ID, TB_RLS_INSP.RI_NT, sum(TB_RLS_INSP.RI_URLS) as "RI_URLS",
		    tb_ord.ord_no, tb_ord.clt_no, tb_ord.ord_shp_cat,
		    TB_RLS.rls_code, sum(tb_pic.pic_qty) as "pic_qty", TB_CLT.CLT_NAME
		from TB_RLS_INSP
		INNER JOIN tb_ord_itm on tb_rls_insp.oi_no = tb_ord_itm.oi_no
		inner join tb_pic on tb_pic.oi_no = tb_ord_itm.oi_no
		INNER JOIN tb_ord on TB_ORD_ITM.ord_no = TB_ORD.ord_no
		INNER JOIN tb_rls on TB_ORD.ord_no = tb_rls.ord_no
		inner join tb_clt on tb_ord.clt_no = tb_clt.clt_no
		WHERE TB_RLS.RLS_CODE = #{releaseCode}
	</select>
 	
</mapper>

